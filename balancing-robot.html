<!DOCTYPE html>
<html lang="en">
<head>
	<title>Balancing Robot</title>
	<meta charset="utf-8" />
	<meta name="author" content="Jason Dorweiler" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<!-- JS Libraries to Load -->
	<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
	<script src="http://www.transistor.io/theme/js/bootstrap.min.js"></script>
	<script src="http://www.transistor.io/theme/js/progressbars.js"></script>
	
	
	<!-- CSS Styles -->
	<link rel="stylesheet" href="http://www.transistor.io/theme/css/bootstrap.simplex.min.css" type="text/css" />
	<link rel="stylesheet" href="http://www.transistor.io/theme/css/bootstrap-responsive.min.css" type="text/css" />
	<link rel="stylesheet" href="http://www.transistor.io/theme/css/font-awesome.min.css" type="text/css" />
	<link rel="stylesheet" href="http://www.transistor.io/theme/css/main.css" type="text/css">
	<link rel="stylesheet" href="http://www.transistor.io/theme/css/pygment.css" type="text/css">
	<!--[if IE 7]>
	<link rel="stylesheet" href="http://www.transistor.io/theme/css/font-awesome-ie7.min.css">
	<![endif]-->
	
	<!-- Feed Information / Copied from Simple Theme -->
	<link href="http://www.transistor.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="transistor.io Full Atom Feed" />
	<link href="http://www.transistor.io/feeds/Projects.atom.xml" type="application/atom+xml" rel="alternate" title="transistor.io Categories Atom Feed" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-41941180-1', 'transistor.io');
  ga('send', 'pageview');

</script>

<link href="//vjs.zencdn.net/4.4/video-js.css" rel="stylesheet">
<script src="//vjs.zencdn.net/4.4/video.js"></script>
<style>
.video-js {padding-top: 56.25%}
.vjs-fullscreen {padding-top: 0px}
</style>

</head>
<body>
<div class="navbar navbar-fixed-top">
	<div class="navbar-inner">
		<div class="container pull-left offset1">
			<a class="btn btn-navbar clearfix pull-right" data-target=".navbar-responsive-collapse" data-toggle="collapse">
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</a>
			<a class="brand" href="http://www.transistor.io/index.html">transistor.io </a>
			
			<div class="nav-collapse collapse navbar-responsive-collapse">
				<ul class="nav">
					<li>
						<a href="http://www.transistor.io/pages/about-me.html"><i class="icon-user" ></i>About me</a>
					</li>
					<li class="divider-vertical"></li>
					<li >
						<a href="http://www.transistor.io/category/chemistry.html"><i class="icon-folder-open icon-large"></i> Chemistry</a>
					</li>
					<li class="divider-vertical"></li>
					<li >
						<a href="http://www.transistor.io/category/climbing.html"><i class="icon-folder-open icon-large"></i> Climbing</a>
					</li>
					<li class="divider-vertical"></li>
					<li class="active">
						<a href="http://www.transistor.io/category/projects.html"><i class="icon-folder-open icon-large"></i> Projects</a>
					</li>
					<li class="divider-vertical"></li>
				<li >
					<a href="http://www.transistor.io/archives.html"><i class="icon-th-list"></i> Archives</a>
				</li>
				
				</ul>
			</div>
		</div>
	</div>
</div>
<div class="container-fluid" id="content">
	<div class="row-fluid">
		<div class="span1"></div>
		<div class="span10">
			<div class="row">
				<div class="offset1 span8">
<section id="content">
<article>
	<header>
			<h1>
					<a href=""
							rel="bookmark"
							title="Permalink to Balancing Robot">
							Balancing Robot
					</a>
			</h1>
	</header>
	
	<div class="entry-content">
	
	<div class="well">
<div class="row-fuild">
	<div class="span6">
	<span class="label text-center">Date</span>
	<abbr class="published" title="2012-05-27T00:00:00">
		<i class="icon-calendar"></i>Sun 27 May 2012
	</abbr>
	</div>
	<div class="span1">&nbsp;</div>
	<div class="span5">
		<span class="label text-center">Tags</span>
			<a href="http://www.transistor.io/tag/robotics.html">robotics</a>
			<a href="http://www.transistor.io/tag/programming.html">programming</a>
			<a href="http://www.transistor.io/tag/balancing-robot.html">balancing robot</a>
			<a href="http://www.transistor.io/tag/pcb.html">PCB</a>
	</div>
</div>	</div>
	<p><img alt="" src="images/balancingrobot/title.png" /></p>
<p>The goal of this project is to make a self balancing robot, also called an <a href="http://en.wikipedia.org/wiki/Inverted_pendulum" target="_blank">inverted pendulum</a>. The basic idea is that you have a mass located above its pivot point. This causes the robot to be unstable, and without any help, it will quickly fall over. Sensors on the robot will take acceleration and gyroscope measurements, which are sent to a control algorithm. As the robot starts to fall, the control algorithm will send a signal to the motor, telling it which direction and how much to move in order to keep the robot upright. 
This project involves a huge range of knowledge from mathematics, mechanics, and programming. And as I've quickly learned, the theory is a lot more complex than I originally thought. 
When I set out to make this robot, I decided to work towards a few specific goals: </p>
<ol>
<li>Keep the cost as low as possible </li>
<li>Print all of the mechanical/structural parts on my 3D printer </li>
</ol>
<p><strong>Structural</strong>
<br> 
I decided to use a four level design. The lower level holds the motor and the bushings for the axle. The second level holds the Arduino Uno board. The third level contains the H-bridge and the sensors. The fourth level holds the batteries. 
Designing the structural parts was fairly easy. All the levels except for the first are just flat rectangles. The first level, holding the motor and axle, was a bit more complex.  I&#8217;m using spur gears to drive the wheels for  now.  I may switch to <a href="http://en.wikipedia.org/wiki/Herringbone_gear" target="_blank">herringbone gears</a> if backlash becomes a problem. 
Here&#8217;s a picture showing the three levels (battery level not shown) </p>
<p><img alt="robot" src="images/balancingrobot/robot.jpg" /></p>
<p><strong>Electronics</strong>
<br>
I had originally planned on building my own sensor board to keep the costs down. The accelerometer and gyroscope can be bought for about $5 total. The only problem is that they&#8217;re very small chips- about 3mm x 3mm. The pads are even smaller at about 0.4mm. I managed to solder a few of the connections, but ended up pulling off a pad on the accelerometer. Instead, I decided to buy a pre-made 6 degree of freedom board that had the accelerometer and gyroscope already on it. 
I&#8217;m using an H-bridge (<a href="http://www.ti.com/lit/ds/symlink/sn754410.pdf" target="_blank">sn754410</a>) to control the motor. The logic level for the H-bridge is 4.5V, which is higher than the 3.3V that the i/o pins on the arduino can put out.  The motor will be connected to a 12V source, so I used level shifter with MOSFETs and 5V zener diodes to bring the 3.3V signal up above that level. 
Here&#8217;s the completed electronics set up on a breadboard.</p>
<p><img alt="electronics" src="images/balancingrobot/electronics.png" /></p>
<p><strong>Code</strong> 
<br>
The actual code to run the robot is my biggest hurdle right now. I don&#8217;t have a lot of experience writing C code, so I&#8217;ll consider this a crash course. So far I&#8217;ve gotten the communication with the accelerometer and gyroscope working. This was actually fairly easy since both sensors run on <a href="http://en.wikipedia.org/wiki/I%C2%B2C" target="_blank">I<sup>2</sup>C</a>.  I&#8217;ll wait until I have the completed code to post it. 
I&#8217;ve also gotten the calculation for the <a href="http://en.wikipedia.org/wiki/Orbital_inclination" target="_blank">inclination angle</a> to work. The inclination angle measures the angle that the Z-axis of the robot makes with the direction of gravity (from the accelerometer). This <a href="http://www.analog.com/static/imported-files/application_notes/AN-1057.pdf" target="_blank">data sheet</a> for a different accelerometer give a very good explanation of how to calculate the inclination angle. Here&#8217;s the take home message: 
The inclination angle can be using the following equation:
<br>
<br>
<img alt="eq1" src="images/balancingrobot/eq1.png" />
<br>
<br>
Where g is the vector in the direction of gravity and given by the magnitude of the X and Z vectors from the acceleration data. 
<br>
<br>
<img alt="eq2" src="images/balancingrobot/eq2.png" />
<br>
<br>
From this, it&#8217;s easy to do a linear approximation for the inclination angle given by: 
<br>
<br>
<img alt="eq3" src="images/balancingrobot/eq3.png" />
<br>
<br>
This equation will output a number ranging from 0 (upright, 0 degrees) to 1 (fallen, 90 degrees).  The plot below (borrowed from the data sheet) shows the exact Θ calculation and the  linear approximation that I&#8217;ll be using.  The linear approximation fits very well at Θ angles less than  about 20<sup>o</sup>.  This is perfectly fine for the robot since it won&#8217;t be able to recover from a 20<sup>o</sup> Θ angle anyway. 
<br>
<br>
<img alt="graph" src="images/balancingrobot/graph.png" />
<br>
<br>
The drawing below shows the inclination angle (Θ) and how it changes as the robot falls. The inclination angle when it&#8217;s standing perfectly upright will be 0 and it increases until it hits the ground, at which point the inclination will be 1 or sin<sup>-1</sup>(1)=π/2.
<br>
<br>
<img alt="incl" src="images/balancingrobot/inclination.png" />
<br>
<br>
This is what the output for the inclination looks like on the serial monitor.
<br>
<br>
<div class="row">
<div class="span1">
</div>
<div class="span12">
<img alt="test" src="images/balancingrobot/acceltest.png" />
</div>
</div
<br>
<br>
The next plan is to get the gyroscope calculation to work and use it with the accelerometer in a <a href="http://en.wikipedia.org/wiki/Kalman_filter" target="_blank">Kalman filter</a>.
<br>
<br>
<a name="robot2"></a>
          </br>
          </br>
<h2>Balancing Robot Ver. 2</h2>
I found a fatal flaw in the design for the first version of the balancing robot.  Now that I have everything working on it, I can 
see that the motor from the surplus store does not have nearly have enough torque to keep the robot from falling.<br />
As the robot begins to tip, the motor tries to catch it, but it just can't do it.<br />
<br>
This is what it looks like.  It will fall over pretty quickly if I let go of it.  The two LEDs on the controller board
           indicate its forward or reverse direction, so you can see that it's trying to balance. 
           <br>
           <br>
           <iframe width="420" height="315" src="http://www.youtube.com/embed/KAWaZL0QWDc" frameborder="0" allowfullscreen></iframe>
           <br>
           <br>
           I changed the design a bit to use some stepper motors from an old laser printer.  Stepper motors have plenty
           of torque, but they don't move very quickly, which I worry may be another problem.  This idea was also short-lived.  The stepper motors
           did have plenty of torque, but their jerky movement caused a lot of vibration in the robot.  This vibration made the gyroscope sensor very 
           noisy.  I decided to order some continuous rotation servos and try to use them instead.  Servos also don't move very quickly but have plenty of 
           torque and should move much more smoothly than the stepper motors.<br />
           <br>
           <br>
That's enough of the design aspect for now.  On to the rest of the theory. </p>
<p>I have now implemented both the Kalman filter and PID controller.  PID stands for Porportional Integral Derivative.  Here is a nice block diagram showing the basic flow of data for the PID (borrowed from wikipedia).  The raw data goes into the PID and different parameters are applied to it.  The different parts of the PID are then combined and sent to the robot as a motor movement command.  Then a feedback loop
           sends the results of the actual motion back through the filters again. 
           <br> 
           <br>
           <img alt="pid" src="images/balancingrobot/pid.png" />
           <br>
           <br>
           Mathmatically the PID control looks like this: 
           <br>
           <img alt="pideq" src="images/balancingrobot/pideq.png" />
           <br>
           Where Kp, Ki, and Kd represent the proportional, integral, and derivative perameters, respectively. The proportional parameter
           acts as a mutiplier and produces an output that is proportional to the current error measurement.  The integral parameter
           represents the accumulation of past errors.  A high Ki will act to resist even the smallest change in movement. Since it is
           based on past errors, it may cause the present value to overshoot the desired point.  The derivative parameter is the slope of the 
           error over time and effectively works to dampen any large corrections that might otherwise overshoot the set point.  Large Kd 
           values will also greatly slow the correction response.
           <br>
           <br>
            The Kalman filter is a complex subject.  I'll try my best to give a simple (non-mathematical) explanation.
           The basic idea is that a perfect model for the motion and angle of the robot exists. Unfortunately, 
           this perfect model is very difficult or impossible to determine.  There are just too many unknown variables in 
           the system to determine this model.  Instead, we can use the imperfect measurements 
           from the accelerometer, gyroscope, and a Kalman filter to get a very good estimate of the angle. 
           <br>
           <br>
           The two sensors give an estimate of the angle, but their measurements are not 100% accurate.  There is noise, bias,
           and drift to deal with.  The Kalman filter is a way to put these two sensor measurements together to get a
           better estimate of what is happening with the robot i.e., the inclination angle.
           <br>
           <br>
           The end result of the PID and Kalman filter is to clean up what will otherwise be a noisy signal.  The signal from the accelerometer is dependent on the gravitational force felt on each axis.  As the robot falls over, it will show an acceleration toward the floor.  Likewise, as the fall is corrected, it will show acceleration away from the floor.  If the acceleration away from the floor is great enough, the signal from the accelerometer will look as if the robot has greatly over-corrected.  This is bad for any steady equilibrium.  The two filters will hopefully take care of this problem. 
           <br>
           <br>
           <img alt="pidtest" src="images/balancingrobot/pidtest.png" />
           <br>
           <br>
           <a name="robot3"></a>
          </br>
          </br>
<h2>Balancing Robot Ver. 3</h2>
           <br>
           <p>Robot gets a makeover plus a DIY printed circuit board</p>
<p>The servo motors arrived, and I did a quick hack job of gluing the new motors on in order to test them.  Good news, it works! The new motors do a pretty good job of balancing the robot.  At 50 rpm max, they're a bit on the slow side, so the robot has a bit of trouble recovering from large pushes. 
           <br>
           <br>
           I decided to make a new printed motor platform specifically to hold the new servos.  I also printed new wheels.  I was
           worried about the ridigity of the whole robot after seeing how excessive vibrations caused the sensors to go 
           crazy in version 2.  The new wheels are very rigid, and everything is nicely glued together now.<br />
           <br>
           <br>
           <div class="row">
           <div class="span5">
           <img alt="robot3" src="images/balancingrobot/robot3.png" /> 
           </div>
           <div class="span6">
           <iframe width="420" height="315" src="http://www.youtube.com/embed/C3bnK1rgoRc" frameborder="0" allowfullscreen></iframe>
           </div>
           </div>
           <br>
           <br>
           I have been visiting the local hacker space (<a href="http://www.fubarlabs.org/" target="_blank">FUBAR Labs</a>) where I learned about a very easy-to-use PCB layout software called 
           <a href="http://fritzing.org/" target="_blank">Fritzing</a>.  I used this program to design a protoype for 
           an Arduino motor/sensor shield.  I took the original H-bridge design and expanded it to be more useful.  The board
           has the H-bridge, which can control two DC motors or one stepper motor, accelerometer/gyroscope, and two servo connections.
           <br>
           <br>
           <img alt="pcb1" src="images/balancingrobot/pcb1.png" /> 
           <br>
           <br>
           I printed out the design using a laser printer onto <a href="http://www.digikey.com/product-detail/en/50-1101/182-1003-ND/3386" target="_blank">dextrin coated paper</a>.
           Then the toner was transferred to the copper board using a laminator. Finally, the excess copper was etched away using ferric chloride. 
           Here's the etched board.
           <br>
           <br>
           <img alt="pcb3" src="images/balancingrobot/pcb3.png" />
           <br>
           <br>
           Here's the assembled board on the robot.  Its at a point now where it can balance indefinitely and recover from small pushes.  The servos are 
           a bit too slow for it to recover from larger pushes like I expected.
           <br>
           <br><br />
           <div class="row">
           <div class="span6">
            <img alt="robot4" src="images/balancingrobot/robot4.png" />
            </div>
            <div class="span6"> 
            <img alt="robot5" src="images/balancingrobot/robot5.png" />
            </div>
            </div>
            <br>
            <br>
            And a video of the final robot!
            <br>
            <br>
            <iframe width="420" height="315" src="http://www.youtube.com/embed/LAWjUlzAYf0" frameborder="0" allowfullscreen></iframe>
            <br>
            <br>
            I've placed all of the code and 3d printer files on my <a href="http://github.com/jdorweiler/BalancingRobot">Github page</a>.
            And here are a few links that I found very useful in builing this robot 
            <br>
            <a href="http://www.arduino.cc/cgi-bin/yabb2/YaBB.pl?num=1284738418/all">http://www.arduino.cc/cgi-bin/yabb2/YaBB.pl?num=1284738418/all</a>
            <br>
            <a href="http://www.kerrywong.com/2012/03/08/a-self-balancing-robot-i">http://www.kerrywong.com/2012/03/08/a-self-balancing-robot-i</a></p>
	</div><!-- /.entry-content -->
	<div class="comments">
	<h2>Comments !</h2>
			<div id="disqus_thread"></div>
			<script type="text/javascript">
        var disqus_shortname = 'jd-transistorio'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
	</div>
</article>
</section>
				</div>
				<div class="span3">
<ul class="nav nav-list well sidebar">
	<li class="nav-header">
		<h4>
			<i class="icon-rss icon-large"></i> 
			RSS/Atom Feeds
		</h4>
	</li>
	<li>
		<a href="http://www.transistor.io/feeds/all.atom.xml" rel="alternate">
		<i class="icon-bookmark icon-large"></i>
		Atom Feed
		</a>
	</li>
	<li class="nav-header"><h4><i class="icon-external-link"></i>Blogroll</h4></li>
		<li><a href="http://www.theamphour.com/"><i class="icon-external-link"></i>The Amp Hour</a></li>
		<li><a href="http://www.hackaday.com"><i class="icon-external-link"></i>Hack A Day</a></li>
		<li><a href="http://dangerousprototypes.com/"><i class="icon-external-link"></i>Dangerous Prototypes</a></li>
	<li class="nav-header"><h4><i class="icon-home icon-large"></i> Social</h4></li>
		<li><a href="http://github.com/jdorweiler"><i class="icon-github icon-large"></i>GitHub</a></li>
		<li><a href="http://www.linkedin.com/profile/view?id=85206177&trk=nav_responsive_tab_profile_pic"><i class="icon-linkedin icon-large"></i>LinkedIn</a></li>
		<li><a href="https://twitter.com/jdorw"><i class="icon-twitter icon-large"></i>twitter</a></li>
	
	<li class="nav-header"><h4><i class="icon-folder-close icon-large"></i>Categories</h4></li>
	
	<li>
		<a href="http://www.transistor.io/category/chemistry.html">
		<i class="icon-folder-open icon-large"></i>
		Chemistry
		</a>
	</li>
	<li>
		<a href="http://www.transistor.io/category/climbing.html">
		<i class="icon-folder-open icon-large"></i>
		Climbing
		</a>
	</li>
	<li>
		<a href="http://www.transistor.io/category/projects.html">
		<i class="icon-folder-open icon-large"></i>
		Projects
		</a>
	</li>
	
	<li class="nav-header"><h4><i class="icon-tags icon-large"></i>Tags</h4></li>
	<li class="tag-4">
		<a href="http://www.transistor.io/tag/carbon-fiber.html">
        <i class="icon-tag icon-large"></i>carbon fiber
		</a>
	</li>
	<li class="tag-3">
		<a href="http://www.transistor.io/tag/balancing-robot.html">
        <i class="icon-tag icon-large"></i>balancing robot
		</a>
	</li>
	<li class="tag-4">
		<a href="http://www.transistor.io/tag/arduino.html">
        <i class="icon-tag icon-large"></i>arduino
		</a>
	</li>
	<li class="tag-4">
		<a href="http://www.transistor.io/tag/electroncis.html">
        <i class="icon-tag icon-large"></i>electroncis
		</a>
	</li>
	<li class="tag-1">
		<a href="http://www.transistor.io/tag/robotics.html">
        <i class="icon-tag icon-large"></i>robotics
		</a>
	</li>
	<li class="tag-4">
		<a href="http://www.transistor.io/tag/biking.html">
        <i class="icon-tag icon-large"></i>biking
		</a>
	</li>
	<li class="tag-2">
		<a href="http://www.transistor.io/tag/ros.html">
        <i class="icon-tag icon-large"></i>ros
		</a>
	</li>
	<li class="tag-3">
		<a href="http://www.transistor.io/tag/rock-climbing.html">
        <i class="icon-tag icon-large"></i>rock climbing
		</a>
	</li>
	<li class="tag-3">
		<a href="http://www.transistor.io/tag/pcb.html">
        <i class="icon-tag icon-large"></i>PCB
		</a>
	</li>
	<li class="tag-2">
		<a href="http://www.transistor.io/tag/turtlebot.html">
        <i class="icon-tag icon-large"></i>turtlebot
		</a>
	</li>
	<li class="tag-2">
		<a href="http://www.transistor.io/tag/hackaday.html">
        <i class="icon-tag icon-large"></i>hackaday
		</a>
	</li>
	<li class="tag-4">
		<a href="http://www.transistor.io/tag/chemistry.html">
        <i class="icon-tag icon-large"></i>chemistry
		</a>
	</li>
	<li class="tag-3">
		<a href="http://www.transistor.io/tag/roomba.html">
        <i class="icon-tag icon-large"></i>roomba
		</a>
	</li>
	<li class="tag-2">
		<a href="http://www.transistor.io/tag/computer-vision.html">
        <i class="icon-tag icon-large"></i>computer vision
		</a>
	</li>
	<li class="tag-1">
		<a href="http://www.transistor.io/tag/autonomous-car.html">
        <i class="icon-tag icon-large"></i>autonomous car
		</a>
	</li>
	<li class="tag-1">
		<a href="http://www.transistor.io/tag/programming.html">
        <i class="icon-tag icon-large"></i>programming
		</a>
	</li>
</ul>
				</div>
			</div>
		</div>
		<div class="span1"></div>
	</div>
</div>

<footer class="navbar-fixed-bottom text-center">
Copyright &copy; 2014 by Jason Dorweiler
</footer>
</body>
</html>